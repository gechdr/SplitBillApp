<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Split Bill - Split Your Bills Easily</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ’°</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'slide-down': 'slideDown 0.2s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out'
                    },
                    keyframes: {
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input, select, textarea { font-size: 16px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                title: "Split Bill",
                subtitle: "Split bills easily and fairly",
                autoSaved: "Auto-saved",
                scanReceipt: "Scan Receipt",
                scanReceiptDesc: "Drag & drop, paste (Ctrl+V), or click to upload",
                scanReceiptFormat: "Supports JPG, PNG (max 10MB)",
                chooseFile: "Choose File",
                dropToScan: "Drop to scan",
                scanningReceipt: "Scanning receipt...",
                scanSuccess: "Success! Found",
                scanFailed: "Failed to scan receipt",
                items: "items",
                noteTitle: "Note:",
                noteDesc: "The receipt scanning feature uses OCR and may not be 100% accurate. Please double-check the detected data before using it.",
                peopleList: "People List",
                personNamePlaceholder: "Person name (Press Enter)",
                add: "Add",
                noPeopleAdded: "No people added yet.",
                itemsList: "Items List",
                itemPlaceholder: "Item #",
                deleteItem: "Delete Item",
                addPeopleFirst: "Add people first",
                addItem: "Add Item",
                pricePerUnit: "Per Unit",
                priceTotal: "Total",
                priceTypeLabel: "Price is",
                additionalCosts: "Additional Costs",
                shipping: "Shipping Fee",
                serviceFee: "Service Fee",
                tax: "Tax Percentage",
                parking: "Parking Fee",
                promoDiscount: "Promo Discount",
                voucher: "Voucher Discount",
                bankAccount: "Bank Account",
                selectAccount: "Select transfer destination account",
                addNewAccount: "Add New Account",
                addNewAccountDesc: "Save account for later use",
                accountHolderName: "Account Holder Name",
                accountHolderPlaceholder: "e.g. John Doe",
                accountNumber: "Account Number",
                accountNumberPlaceholder: "e.g. 1234567890",
                bankEwallet: "Bank / E-Wallet",
                bankEwalletPlaceholder: "e.g. BCA, Mandiri, GoPay",
                cancel: "Cancel",
                save: "Save",
                deleteAccount: "Delete account",
                accountSaved: "Account saved successfully!",
                accountExists: "Account already exists!",
                accountDeleted: "Account deleted successfully!",
                paymentSummary: "Payment Summary",
                orderSubtotal: "Order Subtotal:",
                totalDiscount: "Total Discount:",
                otherFees: "Other Fees:",
                total: "Total:",
                transferTo: "Transfer to:",
                splitPerPerson: "Split Per Person:",
                viewDetails: "View Details",
                hideDetails: "Hide Details",
                orderDetails: "Order Details",
                itemsOrdered: "Items Ordered",
                noItems: "No items",
                download: "Download",
                copyImage: "Copy Image",
                processing: "Processing...",
                downloaded: "Downloaded successfully!",
                copied: "Copied successfully!",
                failedToCopy: "Failed to copy",
                failedToProcess: "Failed to process",
                resetTitle: "Reset All Data?",
                resetMessage: "This action will delete all data including items, people, and costs. Data cannot be recovered.",
                reset: "Reset",
                dataReset: "Data reset successfully!",
                fileMustBeImage: "File must be an image",
                tooltipLanguage: "Switch language between English and Indonesian",
                tooltipOCR: "Toggle OCR scanner to scan receipt images",
                tooltipReset: "Reset all data including items, people, and costs",
                tooltipAddPerson: "Add a new person to split the bill with",
                tooltipRemovePerson: "Remove this person from the list",
                tooltipDeleteItem: "Delete this item from the list",
                tooltipAddItem: "Add a new item to the bill",
                tooltipDeleteAccount: "Delete this saved account",
                tooltipDownload: "Download payment summary as image",
                tooltipCopy: "Copy payment summary image to clipboard",
                tooltipViewDetails: "Show/hide detailed breakdown for this person",
                tooltipPricePerUnit: "Price is per unit - each person pays this amount",
                tooltipPriceTotal: "Price is total - split equally among selected people",
                tooltipPersonSelect: "Click to include/exclude this person for this item",
                tooltipPersonName: "Enter person's name and press Enter to add",
                tooltipItemName: "Enter the name of the item",
                tooltipItemPrice: "Enter the price amount (numbers only)",
                tooltipShipping: "Enter shipping/delivery cost",
                tooltipServiceFee: "Enter service fee amount",
                tooltipTax: "Enter tax percentage (e.g. 10 for 10%)",
                tooltipParking: "Enter parking fee amount",
                tooltipDiscount: "Enter promo discount amount",
                tooltipVoucher: "Enter voucher discount amount",
                tooltipAccountName: "Enter the account holder's full name",
                tooltipAccountNumber: "Enter the account number",
                tooltipBankName: "Enter bank or e-wallet name (e.g. BCA, GoPay)",
                roundTo100: "Round to 100",
                tooltipRounding: "Round each person's bill to nearest 100"
            },
            id: {
                title: "Patungan",
                subtitle: "Bagi biaya dengan mudah dan adil",
                autoSaved: "Tersimpan otomatis",
                scanReceipt: "Pindai Struk",
                scanReceiptDesc: "Seret & lepas, tempel (Ctrl+V), atau klik untuk upload",
                scanReceiptFormat: "Mendukung JPG, PNG (maks 10MB)",
                chooseFile: "Pilih File",
                dropToScan: "Lepas untuk memindai",
                scanningReceipt: "Memindai struk...",
                scanSuccess: "Berhasil! Ditemukan",
                scanFailed: "Gagal memindai struk",
                items: "item",
                noteTitle: "Catatan:",
                noteDesc: "Fitur pemindaian struk menggunakan OCR dan mungkin tidak 100% akurat. Mohon periksa kembali data yang terdeteksi sebelum digunakan.",
                peopleList: "Daftar Orang",
                personNamePlaceholder: "Nama orang (Tekan Enter)",
                add: "Tambah",
                noPeopleAdded: "Belum ada orang yang ditambahkan.",
                itemsList: "Daftar Barang",
                itemPlaceholder: "Barang #",
                deleteItem: "Hapus Barang",
                addPeopleFirst: "Tambahkan orang terlebih dahulu",
                addItem: "Tambah Barang",
                pricePerUnit: "Per Satuan",
                priceTotal: "Total",
                priceTypeLabel: "Harga adalah",
                additionalCosts: "Biaya Tambahan",
                shipping: "Biaya Ongkir",
                serviceFee: "Biaya Layanan",
                tax: "Persentase Pajak",
                parking: "Biaya Parkir",
                promoDiscount: "Diskon Promo",
                voucher: "Diskon Voucher",
                bankAccount: "Rekening Bank",
                selectAccount: "Pilih rekening tujuan transfer",
                addNewAccount: "Tambah Rekening Baru",
                addNewAccountDesc: "Simpan rekening untuk digunakan nanti",
                accountHolderName: "Nama Pemilik Rekening",
                accountHolderPlaceholder: "contoh: John Doe",
                accountNumber: "Nomor Rekening",
                accountNumberPlaceholder: "contoh: 1234567890",
                bankEwallet: "Bank / E-Wallet",
                bankEwalletPlaceholder: "contoh: BCA, Mandiri, GoPay",
                cancel: "Batal",
                save: "Simpan",
                deleteAccount: "Hapus rekening",
                accountSaved: "Rekening berhasil disimpan!",
                accountExists: "Rekening sudah ada!",
                accountDeleted: "Rekening berhasil dihapus!",
                paymentSummary: "Ringkasan Pembayaran",
                orderSubtotal: "Subtotal Pesanan:",
                totalDiscount: "Total Diskon:",
                otherFees: "Biaya Lainnya:",
                total: "Total:",
                transferTo: "Transfer ke:",
                splitPerPerson: "Bagi Per Orang:",
                viewDetails: "Lihat Detail",
                hideDetails: "Sembunyikan Detail",
                orderDetails: "Detail Pesanan",
                itemsOrdered: "Barang yang Dipesan",
                noItems: "Tidak ada barang",
                download: "Unduh",
                copyImage: "Salin Gambar",
                processing: "Memproses...",
                downloaded: "Berhasil diunduh!",
                copied: "Berhasil disalin!",
                failedToCopy: "Gagal menyalin",
                failedToProcess: "Gagal memproses",
                resetTitle: "Reset Semua Data?",
                resetMessage: "Tindakan ini akan menghapus semua data termasuk barang, orang, dan biaya. Data tidak dapat dikembalikan.",
                reset: "Reset",
                dataReset: "Data berhasil direset!",
                fileMustBeImage: "File harus berupa gambar",
                tooltipLanguage: "Ganti bahasa antara English dan Indonesian",
                tooltipOCR: "Toggle scanner OCR untuk memindai gambar struk",
                tooltipReset: "Reset semua data termasuk barang, orang, dan biaya",
                tooltipAddPerson: "Tambah orang baru untuk patungan",
                tooltipRemovePerson: "Hapus orang ini dari daftar",
                tooltipDeleteItem: "Hapus barang ini dari daftar",
                tooltipAddItem: "Tambah barang baru ke tagihan",
                tooltipDeleteAccount: "Hapus rekening tersimpan ini",
                tooltipDownload: "Unduh ringkasan pembayaran sebagai gambar",
                tooltipCopy: "Salin gambar ringkasan pembayaran ke clipboard",
                tooltipViewDetails: "Tampilkan/sembunyikan rincian detail untuk orang ini",
                tooltipPricePerUnit: "Harga per satuan - setiap orang bayar sejumlah ini",
                tooltipPriceTotal: "Harga total - dibagi rata di antara orang yang dipilih",
                tooltipPersonSelect: "Klik untuk sertakan/kecualikan orang ini untuk barang ini",
                tooltipPersonName: "Masukkan nama orang dan tekan Enter untuk menambah",
                tooltipItemName: "Masukkan nama barang",
                tooltipItemPrice: "Masukkan jumlah harga (angka saja)",
                tooltipShipping: "Masukkan biaya ongkos kirim",
                tooltipServiceFee: "Masukkan jumlah biaya layanan",
                tooltipTax: "Masukkan persentase pajak (contoh: 10 untuk 10%)",
                tooltipParking: "Masukkan jumlah biaya parkir",
                tooltipDiscount: "Masukkan jumlah diskon promo",
                tooltipVoucher: "Masukkan jumlah diskon voucher",
                tooltipAccountName: "Masukkan nama lengkap pemilik rekening",
                tooltipAccountNumber: "Masukkan nomor rekening",
                tooltipBankName: "Masukkan nama bank atau e-wallet (contoh: BCA, GoPay)",
                roundTo100: "Bulatkan ke 100",
                tooltipRounding: "Bulatkan tagihan setiap orang ke 100 terdekat"
            }
        };

        // --- ICONS ---
        const Trash2 = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        );
        const Plus = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
        );
        const DollarSign = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        );
        const Users = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        );
        const CreditCard = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
        );
        const Download = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
        );
        const Copy = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
        );
        const ChevronDown = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
        );
        const Check = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
        );
        const Camera = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        );
        const Upload = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
        );
        const RefreshCw = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
        );
        const Globe = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        );
        const Eye = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
        );
        const EyeOff = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" /></svg>
        );
        const Moon = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
        );
        const Sun = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        );
        const GripVertical = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="19" r="1" fill="currentColor"/><circle cx="15" cy="5" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="19" r="1" fill="currentColor"/></svg>
        );
        const Calculator = ({ className }) => (
            <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
        );

        // --- HELPER COMPONENT: Formatted Input ---
        const FormattedInput = ({ label, value, onChange, type = 'currency', placeholder = '0', title }) => {
            const handleChange = (e) => {
                const rawValue = e.target.value.replace(/[^0-9]/g, '');
                onChange(rawValue);
            };

            const displayValue = value ? Number(value).toLocaleString('id-ID') : '';

            return (
                <div>
                    {label && <label className="block text-xs font-medium text-gray-500 dark:text-gray-300 uppercase mb-1">{label}</label>}
                    <div className="relative rounded-md shadow-sm">
                        {type === 'currency' && (
                            <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                <span className="text-gray-500 dark:text-gray-400 sm:text-sm font-medium">Rp</span>
                            </div>
                        )}
                        <input
                            type="text" 
                            inputMode="numeric"
                            value={displayValue}
                            onChange={handleChange}
                            placeholder={placeholder}
                            className={`block w-full rounded-lg border border-gray-300 dark:border-gray-600 py-2.5 focus:border-gray-900 dark:focus:border-gray-500 focus:ring-1 focus:ring-gray-900 dark:focus:ring-gray-500 text-base sm:text-sm focus:outline-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 ${
                                type === 'currency' ? 'pl-10 pr-4' : 'pl-4 pr-8'
                            }`}
                            title={title || (type === 'percentage' ? 'Enter percentage' : 'Enter amount')}
                        />
                        {type === 'percentage' && (
                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                <span className="text-gray-500 dark:text-gray-400 sm:text-sm font-medium">%</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- CUSTOM ACCOUNT SELECTOR COMPONENT ---
        const AccountSelector = ({ options, selectedValue, onChange, label, customName, customNumber, customVendor, onCustomNameChange, onCustomNumberChange, onCustomVendorChange, onSaveCustomAccount, onDeleteAccount, t }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [showCustomModal, setShowCustomModal] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const selectedOption = options.find(opt => opt.number === selectedValue) || options[0];
            
            const customOption = options.find(opt => opt.number === 'CUSTOM');
            const regularAccounts = options.filter(opt => opt.number !== 'CUSTOM');

            const handleSelect = (accountNumber) => {
                if (accountNumber === 'CUSTOM') {
                    setIsOpen(false);
                    setShowCustomModal(true);
                } else {
                    onChange(accountNumber);
                    setIsOpen(false);
                }
            };

            const handleDelete = (e, accountNumber) => {
                e.stopPropagation();
                if (accountNumber !== 'CUSTOM' && onDeleteAccount) {
                    onDeleteAccount(accountNumber);
                }
            };

            const handleSaveCustom = () => {
                if (customName.trim() && customNumber.trim() && customVendor.trim()) {
                    onSaveCustomAccount();
                    setShowCustomModal(false);
                }
            };

            const handleCancelCustom = () => {
                setShowCustomModal(false);
                onCustomNameChange('');
                onCustomNumberChange('');
                onCustomVendorChange('');
            };

            return (
                <>
                    <div className="space-y-3">
                        <div className="relative" ref={dropdownRef}>
                            {label && <label className="block text-xs font-medium text-gray-500 dark:text-gray-300 uppercase mb-1">{label}</label>}
                            <button
                                type="button"
                                onClick={() => setIsOpen(!isOpen)}
                                className="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg py-2.5 px-4 text-left flex items-center justify-between focus:outline-none focus:ring-1 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-gray-900 dark:focus:border-gray-500"
                            >
                                <span className={`block truncate text-base sm:text-sm ${!selectedOption || selectedOption.number === 'CUSTOM' ? 'text-gray-400 dark:text-gray-500' : 'text-gray-900 dark:text-gray-100'}`}>
                                    {selectedOption && selectedOption.number !== 'CUSTOM'
                                        ? `${selectedOption.name} - ${selectedOption.vendor}` 
                                        : t.selectAccount}
                                </span>
                                <ChevronDown className="w-4 h-4 text-gray-500 dark:text-gray-400" />
                            </button>

                            {isOpen && (
                                <div className="absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 shadow-lg max-h-60 rounded-lg py-1 text-base ring-1 ring-black dark:ring-gray-700 ring-opacity-5 overflow-auto focus:outline-none animate-fade-in sm:text-sm">
                                    {regularAccounts.map((option, index) => (
                                        <div
                                            key={index}
                                            className={`cursor-pointer select-none relative py-3 pl-10 pr-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition ${
                                                option.number === selectedValue ? 'bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-medium' : 'text-gray-700 dark:text-gray-300'
                                            }`}
                                            onClick={() => handleSelect(option.number)}
                                        >
                                            {option.number === selectedValue && (
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-900 dark:text-gray-100">
                                                    <Check className="w-4 h-4" />
                                                </span>
                                            )}
                                            
                                            <div className="flex items-center justify-between">
                                                <div className="flex flex-col flex-1 min-w-0 pr-2">
                                                    <span className="block truncate font-semibold">
                                                        {`${option.name} - ${option.vendor}`}
                                                    </span>
                                                    <span className="block truncate text-xs text-gray-500 dark:text-gray-400">{option.number}</span>
                                                </div>
                                                
                                                <button
                                                    onClick={(e) => handleDelete(e, option.number)}
                                                    className="text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 flex-shrink-0"
                                                    title={t.tooltipDeleteAccount}
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {regularAccounts.length > 0 && (
                                        <div className="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                    )}
                                    
                                    {customOption && (
                                        <div
                                            className="cursor-pointer select-none relative py-3 pl-10 pr-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition text-gray-700 dark:text-gray-300"
                                            onClick={() => handleSelect(customOption.number)}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex flex-col flex-1 min-w-0 pr-2">
                                                    <span className="block truncate font-semibold text-gray-900 dark:text-gray-100">
                                                        âž• {t.addNewAccount}
                                                    </span>
                                                    <span className="block truncate text-xs text-gray-500 dark:text-gray-400">
                                                        {t.addNewAccountDesc}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {showCustomModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 animate-fade-in">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl animate-slide-down">
                                <h3 className="text-lg font-bold text-gray-900 mb-4">{t.addNewAccount}</h3>
                                
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 uppercase mb-1">{t.accountHolderName}</label>
                                        <input
                                            type="text"
                                            value={customName}
                                            onChange={(e) => onCustomNameChange(e.target.value)}
                                            placeholder={t.accountHolderPlaceholder}
                                            className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-1 focus:ring-gray-900 focus:border-gray-900 focus:outline-none bg-white text-base sm:text-sm"
                                            title={t.tooltipAccountName}
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 uppercase mb-1">{t.accountNumber}</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            value={customNumber}
                                            onChange={(e) => onCustomNumberChange(e.target.value)}
                                            placeholder={t.accountNumberPlaceholder}
                                            className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-1 focus:ring-gray-900 focus:border-gray-900 focus:outline-none bg-white text-base sm:text-sm font-mono"
                                            title={t.tooltipAccountNumber}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 uppercase mb-1">{t.bankEwallet}</label>
                                        <input
                                            type="text"
                                            value={customVendor}
                                            onChange={(e) => onCustomVendorChange(e.target.value)}
                                            placeholder={t.bankEwalletPlaceholder}
                                            className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-1 focus:ring-gray-900 focus:border-gray-900 focus:outline-none bg-white text-base sm:text-sm"
                                            title={t.tooltipBankName}
                                        />
                                    </div>
                                </div>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleCancelCustom}
                                        className="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
                                    >
                                        {t.cancel}
                                    </button>
                                    <button
                                        onClick={handleSaveCustom}
                                        disabled={!customName.trim() || !customNumber.trim() || !customVendor.trim()}
                                        className="flex-1 px-4 py-2.5 bg-gray-900 text-white rounded-lg hover:bg-black transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {t.save}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- CONFIRMATION MODAL ---
        const ConfirmModal = ({ isOpen, onConfirm, onCancel, title, message, confirmText, cancelText }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 animate-fade-in">
                    <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-slide-down">
                        <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex gap-3">
                            <button
                                onClick={onCancel}
                                className="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
                            >
                                {cancelText}
                            </button>
                            <button
                                onClick={onConfirm}
                                className="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium"
                            >
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function SplitBill() {
            const appVersion = 'v2.2.0';
            const STORAGE_KEY = 'splitBillData';
            const LANGUAGE_KEY = 'splitBillLanguage';
            
            // Load language from localStorage or default to English
            const loadLanguage = () => {
                try {
                    const savedLanguage = localStorage.getItem(LANGUAGE_KEY);
                    return savedLanguage || 'en';
                } catch (error) {
                    return 'en';
                }
            };

            const [language, setLanguage] = useState(loadLanguage());
            const t = translations[language];

            // Save language to localStorage
            useEffect(() => {
                try {
                    localStorage.setItem(LANGUAGE_KEY, language);
                } catch (error) {
                    console.error('Error saving language:', error);
                }
            }, [language]);

            const toggleLanguage = () => {
                setLanguage(prev => prev === 'en' ? 'id' : 'en');
            };

            // Load initial data from localStorage or use defaults
            const loadFromStorage = () => {
                try {
                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        return JSON.parse(savedData);
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
                return null;
            };

            const initialData = loadFromStorage();

            const [items, setItems] = useState(
                initialData?.items || [{ id: 1, name: '', price: '', persons: [], priceType: 'unit' }]
            );
            const [persons, setPersons] = useState(initialData?.persons || []);
            const [newPersonName, setNewPersonName] = useState('');
            
            const [ongkir, setOngkir] = useState(initialData?.ongkir || '');
            const [biayaLayanan, setBiayaLayanan] = useState(initialData?.biayaLayanan || '');
            const [tax, setTax] = useState(initialData?.tax || ''); 
            const [parking, setParking] = useState(initialData?.parking || '0');
            const [diskon, setDiskon] = useState(initialData?.diskon || '');
            const [voucher, setVoucher] = useState(initialData?.voucher || '');
            
            const [bankAccounts, setBankAccounts] = useState(
                initialData?.bankAccounts || [
                    { name: 'Custom', number: 'CUSTOM', vendor: 'Custom' }
                ]
            );
            
            const [selectedAccount, setSelectedAccount] = useState(
                initialData?.selectedAccount || null
            );
            const [customAccountName, setCustomAccountName] = useState(initialData?.customAccountName || '');
            const [customAccountNumber, setCustomAccountNumber] = useState(initialData?.customAccountNumber || '');
            const [customAccountVendor, setCustomAccountVendor] = useState(initialData?.customAccountVendor || '');
            
            const [isCapturing, setIsCapturing] = useState(false);
            const [captureStatus, setCaptureStatus] = useState('');
            const summaryRef = useRef(null);
            const fileInputRef = useRef(null);
            
            const [isScanning, setIsScanning] = useState(false);
            const [scanProgress, setScanProgress] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            
            const [showResetModal, setShowResetModal] = useState(false);
            const [openAccordions, setOpenAccordions] = useState({});
            const [showOCR, setShowOCR] = useState(false);
            const [darkMode, setDarkMode] = useState(() => {
                try {
                    return localStorage.getItem('darkMode') === 'true';
                } catch {
                    return false;
                }
            });
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);
            const [collapsedSections, setCollapsedSections] = useState({});
            const [roundTo100, setRoundTo100] = useState(initialData?.roundTo100 || false);
            const [showCalculator, setShowCalculator] = useState(false);
            const [calcDisplay, setCalcDisplay] = useState('0');
            const [calcPrevValue, setCalcPrevValue] = useState(null);
            const [calcOperation, setCalcOperation] = useState(null);
            const [calcHistory, setCalcHistory] = useState('');

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                try {
                    localStorage.setItem('darkMode', darkMode);
                } catch (error) {
                    console.error('Error saving dark mode:', error);
                }
            }, [darkMode]);

            // Save to localStorage whenever data changes
            useEffect(() => {
                const dataToSave = {
                    items,
                    persons,
                    ongkir,
                    biayaLayanan,
                    tax,
                    parking,
                    diskon,
                    voucher,
                    bankAccounts,
                    selectedAccount,
                    customAccountName,
                    customAccountNumber,
                    customAccountVendor,
                    roundTo100,
                    lastSaved: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            }, [items, persons, ongkir, biayaLayanan, tax, parking, diskon, voucher, bankAccounts, selectedAccount, customAccountName, customAccountNumber, customAccountVendor, roundTo100]);

            const saveCustomAccount = () => {
                if (customAccountName.trim() && customAccountNumber.trim() && customAccountVendor.trim()) {
                    const newAccount = {
                        name: customAccountName.trim(),
                        number: customAccountNumber.trim(),
                        vendor: customAccountVendor.trim()
                    };
                    
                    const accountExists = bankAccounts.some(
                        acc => acc.number === newAccount.number && acc.number !== 'CUSTOM'
                    );
                    
                    if (!accountExists) {
                        const updatedAccounts = [...bankAccounts, newAccount];
                        setBankAccounts(updatedAccounts);
                        setSelectedAccount(newAccount.number);
                        
                        setCustomAccountName('');
                        setCustomAccountNumber('');
                        setCustomAccountVendor('');
                        
                        setCaptureStatus(t.accountSaved);
                        setTimeout(() => setCaptureStatus(''), 2000);
                    } else {
                        setCaptureStatus(t.accountExists);
                        setTimeout(() => setCaptureStatus(''), 2000);
                    }
                }
            };

            const deleteBankAccount = (accountNumber) => {
                if (accountNumber === 'CUSTOM') return;
                
                const updatedAccounts = bankAccounts.filter(acc => acc.number !== accountNumber);
                setBankAccounts(updatedAccounts);
                
                if (selectedAccount === accountNumber) {
                    setSelectedAccount(null);
                }
                
                setCaptureStatus(t.accountDeleted);
                setTimeout(() => setCaptureStatus(''), 2000);
            };

            const resetAllData = () => {
                setItems([{ id: 1, name: '', price: '', persons: [], priceType: 'unit' }]);
                setPersons([]);
                setNewPersonName('');
                setOngkir('');
                setBiayaLayanan('');
                setTax('');
                setParking('0');
                setDiskon('');
                setVoucher('');
                setSelectedAccount(null);
                setCustomAccountName('');
                setCustomAccountNumber('');
                setCustomAccountVendor('');
                
                const dataToSave = {
                    items: [{ id: 1, name: '', price: '', persons: [], priceType: 'unit' }],
                    persons: [],
                    ongkir: '',
                    biayaLayanan: '',
                    tax: '',
                    parking: '0',
                    diskon: '',
                    voucher: '',
                    bankAccounts: bankAccounts,
                    selectedAccount: null,
                    customAccountName: '',
                    customAccountNumber: '',
                    customAccountVendor: '',
                    lastSaved: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
                
                setShowResetModal(false);
                setCaptureStatus(t.dataReset);
                setTimeout(() => setCaptureStatus(''), 2000);
            };

            const addItem = () => {
                setItems([...items, { id: Date.now() + Math.random() * 1000000, name: '', price: '', persons: [], priceType: 'unit' }]);
            };

            const removeItem = (id) => {
                setItems(items.filter(item => item.id !== id));
            };

            const updateItem = (id, field, value) => {
                setItems(items.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const togglePerson = (itemId, person) => {
                setItems(items.map(item => {
                    if (item.id === itemId) {
                        const persons = item.persons.includes(person)
                            ? item.persons.filter(p => p !== person)
                            : [...item.persons, person];
                        return { ...item, persons };
                    }
                    return item;
                }));
            };

            const addPerson = () => {
                if (newPersonName.trim()) {
                    setPersons([...persons, newPersonName.trim()]);
                    setNewPersonName('');
                }
            };

            const removePerson = (person) => {
                setPersons(persons.filter(p => p !== person));
                setItems(items.map(item => ({
                    ...item,
                    persons: item.persons.filter(p => p !== person)
                })));
            };

            const handleItemDragStart = (e, index) => {
                setDraggedItem(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleItemDragOver = (e, index) => {
                e.preventDefault();
                setDragOverIndex(index);
            };

            const handleItemDragEnd = () => {
                if (draggedItem !== null && dragOverIndex !== null && draggedItem !== dragOverIndex) {
                    const newItems = [...items];
                    const [removed] = newItems.splice(draggedItem, 1);
                    newItems.splice(dragOverIndex, 0, removed);
                    setItems(newItems);
                }
                setDraggedItem(null);
                setDragOverIndex(null);
            };

            const calculateSplit = () => {
                // Calculate subtotal considering priceType
                const subtotal = items.reduce((sum, item) => {
                    const itemPrice = Number(item.price || 0);
                    if (item.priceType === 'total') {
                        return sum + itemPrice;
                    } else {
                        const quantity = item.persons.length || 1;
                        return sum + (itemPrice * quantity);
                    }
                }, 0);
                
                const taxAmount = (subtotal * (Number(tax || 0))) / 100;
                const totalDiscount = Number(diskon || 0) + Number(voucher || 0);
                const sharedFees = Number(ongkir || 0) + Number(biayaLayanan || 0) + Number(parking || 0);
                const totalBiaya = sharedFees + taxAmount;
                
                // Net shared amount = fees - discounts
                const netSharedAmount = sharedFees + taxAmount - totalDiscount;
                
                const totalSetelahDiskon = subtotal - totalDiscount;
                const grandTotal = subtotal + sharedFees + taxAmount - totalDiscount;

                const personTotals = {};
                const personSubtotals = {};
                persons.forEach(person => {
                    personTotals[person] = 0;
                    personSubtotals[person] = 0;
                });

                items.forEach(item => {
                    const itemPrice = Number(item.price || 0);
                    if (item.persons.length > 0 && itemPrice > 0) {
                        let pricePerPerson;
                        
                        if (item.priceType === 'total') {
                            pricePerPerson = itemPrice / item.persons.length;
                        } else {
                            pricePerPerson = itemPrice;
                        }
                        
                        item.persons.forEach(person => {
                            personSubtotals[person] += pricePerPerson;
                        });
                    }
                });

                const totalItemsAssigned = Object.values(personSubtotals).reduce((sum, val) => sum + val, 0);
                
                if (totalItemsAssigned > 0) {
                    persons.forEach(person => {
                        const proportion = personSubtotals[person] / totalItemsAssigned;
                        const netSharedShare = netSharedAmount * proportion;
                        
                        personTotals[person] = personSubtotals[person] + netSharedShare;
                    });
                }

                return { subtotal, taxAmount, totalDiscount, totalBiaya, grandTotal, personTotals, personSubtotals, sharedFees, netSharedAmount };
            };

            const getSelectedAccountName = () => {
                if (selectedAccount === 'CUSTOM') {
                    return customAccountName || 'Custom';
                }
                const account = bankAccounts.find(acc => acc.number === selectedAccount);
                return account ? account.name : '';
            };

            const getSelectedAccountVendor = () => {
                if (selectedAccount === 'CUSTOM') {
                    return customAccountVendor || 'Custom';
                }
                const account = bankAccounts.find(acc => acc.number === selectedAccount);
                return account ? account.vendor : '';
            };

            const getSelectedAccountNumber = () => {
                if (selectedAccount === 'CUSTOM') {
                    return customAccountNumber || '-';
                }
                return selectedAccount;
            };

            const { subtotal, taxAmount, totalDiscount, totalBiaya, grandTotal, personTotals, personSubtotals, sharedFees, netSharedAmount } = calculateSplit();

            const formatMoney = (amount) => amount.toLocaleString('id-ID');
            const formatMoneySplit = (amount) => amount.toLocaleString('id-ID', { maximumFractionDigits: 0 });
            const roundToNearest100 = (amount) => Math.round(amount / 100) * 100;

            const toggleAccordion = (person) => {
                setOpenAccordions(prev => ({
                    ...prev,
                    [person]: !prev[person]
                }));
            };

            const getPersonItems = (person) => {
                return items.filter(item => item.persons.includes(person));
            };

            const parseReceiptText = (text) => {
                const lines = text.split('\n').filter(line => line.trim());
                const detectedItems = [];
                
                const itemWithQtyPattern = /^(\d+)x?\s+(.+?)\s+(?:Rp\.?\s*)?(\d{1,3}(?:[.,]\d{3})+)/i;
                const pricePattern = /(?:Rp\.?\s*)?(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?)/;
                const taxPattern = /(?:tax|pajak|ppn|pb1).*?(\d+)%/i;
                const servicePattern = /(?:service|layanan|order fee|admin).*?(?:Rp\.?\s*)?(\d{1,3}(?:[.,]\d{3})*)/i;
                const deliveryPattern = /(?:delivery|ongkir|ongkos kirim|delivery fee).*?(?:Rp\.?\s*)?(\d{1,3}(?:[.,]\d{3})*)/i;
                
                let totalPromoDiscount = 0;
                let totalVoucher = 0;
                let foundSubtotal = false;
                
                lines.forEach((line, index) => {
                    const cleanLine = line.trim();
                    
                    if (cleanLine.match(/^(subtotal|total|grand total)/i)) {
                        foundSubtotal = true;
                        return;
                    }
                    
                    if (foundSubtotal) return;
                    
                    if (cleanLine.match(/order summary|reorder|terima kasih|thank you|receipt|struk|cutlery|profile|contact|earned|points/i)) {
                        return;
                    }
                    
                    if (cleanLine.toLowerCase().includes('discount') || 
                        cleanLine.toLowerCase().includes('diskon') || 
                        cleanLine.toLowerCase().includes('promo') ||
                        cleanLine.toLowerCase().includes('kota') ||
                        cleanLine.toLowerCase().includes('sobat') ||
                        cleanLine.toLowerCase().includes('voucher')) {
                        
                        const negativeMatch = cleanLine.match(/-\s*(?:Rp\.?\s*)?(\d{1,3}(?:[.,]\d{3})*)/);
                        
                        if (negativeMatch) {
                            const amount = parseInt(negativeMatch[1].replace(/[.,]/g, ''));
                            
                            if (cleanLine.toLowerCase().includes('kota') || 
                                cleanLine.toLowerCase().includes('sobat') ||
                                cleanLine.match(/\d+rb min \d+rb/i)) {
                                totalPromoDiscount += amount;
                            } else {
                                totalVoucher += amount;
                            }
                            return;
                        } else {
                            const positiveMatch = cleanLine.match(/(?:Rp\.?\s*)?(\d{1,3}(?:[.,]\d{3})*)/);
                            if (positiveMatch) {
                                const amount = parseInt(positiveMatch[1].replace(/[.,]/g, ''));
                                if (amount >= 100) {
                                    totalPromoDiscount += amount;
                                }
                            }
                            return;
                        }
                    }
                    
                    const qtyMatch = cleanLine.match(itemWithQtyPattern);
                    if (qtyMatch) {
                        const quantity = parseInt(qtyMatch[1]);
                        const itemName = qtyMatch[2].trim();
                        const totalPrice = qtyMatch[3].replace(/[.,]/g, '');
                        
                        if (itemName.length > 2 && totalPrice.length >= 3) {
                            const unitPrice = Math.round(parseInt(totalPrice) / quantity);
                            
                            for (let i = 0; i < quantity; i++) {
                                detectedItems.push({
                                    id: Date.now() + Math.random() * 1000000 + index * 100 + i,
                                    name: itemName,
                                    price: unitPrice.toString(),
                                    persons: [],
                                    priceType: 'unit'
                                });
                            }
                        }
                        return;
                    }
                    
                    const priceMatch = cleanLine.match(pricePattern);
                    if (priceMatch && !cleanLine.match(/fee|biaya|ongkir|delivery|tax|pajak/i)) {
                        const priceStr = priceMatch[1].replace(/[.,]/g, '');
                        const priceIndex = cleanLine.indexOf(priceMatch[0]);
                        const itemName = cleanLine.substring(0, priceIndex).replace(/^\d+x?\s*/, '').trim();
                        
                        if (itemName && priceStr && itemName.length > 2 && priceStr.length >= 3) {
                            detectedItems.push({
                                id: Date.now() + Math.random() * 1000000 + index * 100,
                                name: itemName,
                                price: priceStr,
                                persons: [],
                                priceType: 'unit'
                            });
                        }
                    }
                });
                
                let detectedTax = '';
                const taxMatch = text.match(taxPattern);
                if (taxMatch) {
                    detectedTax = taxMatch[1];
                }
                
                let detectedService = '';
                const serviceMatch = text.match(servicePattern);
                if (serviceMatch) {
                    detectedService = serviceMatch[1].replace(/[.,]/g, '');
                }
                
                let detectedDelivery = '';
                const deliveryMatch = text.match(deliveryPattern);
                if (deliveryMatch) {
                    detectedDelivery = deliveryMatch[1].replace(/[.,]/g, '');
                }
                
                return {
                    items: detectedItems,
                    tax: detectedTax,
                    biayaLayanan: detectedService,
                    ongkir: detectedDelivery,
                    diskon: totalPromoDiscount > 0 ? totalPromoDiscount.toString() : '',
                    voucher: totalVoucher > 0 ? totalVoucher.toString() : ''
                };
            };

            const handleScanReceipt = async (file) => {
                if (!file) return;
                
                setIsScanning(true);
                setScanProgress(0);
                setCaptureStatus(t.scanningReceipt);
                
                try {
                    const result = await Tesseract.recognize(file, 'ind+eng', {
                        logger: (m) => {
                            if (m.status === 'recognizing text') {
                                setScanProgress(Math.round(m.progress * 100));
                            }
                        }
                    });
                    
                    const parsedData = parseReceiptText(result.data.text);
                    
                    if (parsedData.items.length > 0) {
                        setItems(parsedData.items);
                    }
                    
                    if (parsedData.tax) setTax(parsedData.tax);
                    if (parsedData.biayaLayanan) setBiayaLayanan(parsedData.biayaLayanan);
                    if (parsedData.ongkir) setOngkir(parsedData.ongkir);
                    if (parsedData.parking) setParking(parsedData.parking);
                    if (parsedData.diskon) setDiskon(parsedData.diskon);
                    if (parsedData.voucher) setVoucher(parsedData.voucher);
                    
                    setCaptureStatus(`${t.scanSuccess} ${parsedData.items.length} ${t.items}`);
                } catch (error) {
                    console.error(error);
                    setCaptureStatus(t.scanFailed);
                }
                
                setTimeout(() => {
                    setIsScanning(false);
                    setScanProgress(0);
                    setCaptureStatus('');
                }, 3000);
            };

            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                
                const files = e.dataTransfer.files;
                if (files && files[0]) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        handleScanReceipt(file);
                    } else {
                        setCaptureStatus(t.fileMustBeImage);
                        setTimeout(() => setCaptureStatus(''), 2000);
                    }
                }
            };

            const handlePaste = async (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;
                
                for (let item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            handleScanReceipt(file);
                        }
                        break;
                    }
                }
            };

            useEffect(() => {
                document.addEventListener('paste', handlePaste);
                return () => document.removeEventListener('paste', handlePaste);
            }, []);

            const handleCapture = async (actionType) => {
                if (!summaryRef.current) return;
                setIsCapturing(true);
                setCaptureStatus(t.processing);

                try {
                    await document.fonts.ready;
                    
                    const dataUrl = await domtoimage.toPng(summaryRef.current, {
                        quality: 1,
                        bgcolor: darkMode ? '#1f2937' : '#f9fafb',
                        style: {
                            transform: 'scale(5)',
                            transformOrigin: 'top left',
                            width: summaryRef.current.offsetWidth + 'px',
                            height: summaryRef.current.offsetHeight + 'px'
                        },
                        width: summaryRef.current.offsetWidth * 5,
                        height: summaryRef.current.offsetHeight * 5
                    });

                    if (actionType === 'download') {
                        const link = document.createElement('a');
                        link.download = `split-bill-${Date.now()}.png`;
                        link.href = dataUrl;
                        link.click();
                        setCaptureStatus(t.downloaded);
                    } else {
                        const response = await fetch(dataUrl);
                        const blob = await response.blob();
                        
                        try {
                            await navigator.clipboard.write([
                                new ClipboardItem({ 'image/png': blob })
                            ]);
                            setCaptureStatus(t.copied);
                        } catch (err) {
                            console.error(err);
                            setCaptureStatus(t.failedToCopy);
                        }
                    }
                } catch (error) {
                    console.error(error);
                    setCaptureStatus(t.failedToProcess);
                }

                setTimeout(() => {
                    setCaptureStatus('');
                    setIsCapturing(false);
                }, 2000);
            };

            const handleCalcNumber = (num) => {
                setCalcDisplay(prev => prev === '0' ? num : prev + num);
            };

            const handleCalcOperation = (op) => {
                const current = parseFloat(calcDisplay);
                if (calcPrevValue === null) {
                    setCalcHistory(calcDisplay + op);
                    setCalcPrevValue(current);
                } else {
                    let result = 0;
                    switch(calcOperation) {
                        case '+': result = calcPrevValue + current; break;
                        case '-': result = calcPrevValue - current; break;
                        case 'Ã—': result = calcPrevValue * current; break;
                        case 'Ã·': result = current !== 0 ? calcPrevValue / current : 0; break;
                    }
                    setCalcHistory(result + op);
                    setCalcPrevValue(result);
                    setCalcDisplay(result.toString());
                }
                setCalcOperation(op);
                setCalcDisplay('0');
            };

            const handleCalcEquals = () => {
                if (calcPrevValue === null || calcOperation === null) return;
                const current = parseFloat(calcDisplay);
                let result = 0;
                
                switch(calcOperation) {
                    case '+': result = calcPrevValue + current; break;
                    case '-': result = calcPrevValue - current; break;
                    case 'Ã—': result = calcPrevValue * current; break;
                    case 'Ã·': result = current !== 0 ? calcPrevValue / current : 0; break;
                }
                
                setCalcHistory(calcHistory + calcDisplay);
                setCalcDisplay(result.toString());
                setCalcPrevValue(null);
                setCalcOperation(null);
            };

            const handleCalcClear = () => {
                setCalcDisplay('0');
                setCalcPrevValue(null);
                setCalcOperation(null);
                setCalcHistory('');
            };

            const handleCalcBackspace = () => {
                setCalcDisplay(prev => {
                    if (prev.length <= 1) return '0';
                    return prev.slice(0, -1);
                });
            };

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 py-6 px-3 sm:py-8 sm:px-4 font-sans transition-colors">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-8 border border-gray-100 dark:border-gray-700 transition-colors">
                            {/* Header */}
                            <div className="text-center mb-6 sm:mb-8">
                                <div className="flex flex-col gap-3">
                                    {/* Tool buttons */}
                                    <div className="flex items-center justify-between gap-2">
                                        <button
                                            onClick={toggleLanguage}
                                            className="flex items-center gap-1.5 px-3 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition border border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500"
                                            title={t.tooltipLanguage}
                                        >
                                            <Globe className="w-5 h-5" />
                                            <span className="text-sm font-bold uppercase">{language}</span>
                                        </button>
                                        
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => setDarkMode(!darkMode)}
                                                className="flex items-center gap-1.5 px-3 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                                                title={darkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                                            >
                                                {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                                            </button>
                                            <button
                                                onClick={() => setShowCalculator(!showCalculator)}
                                                className="hidden md:flex items-center gap-1.5 px-3 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                                                title="Toggle calculator"
                                            >
                                                <Calculator className="w-5 h-5" />
                                            </button>
                                            <button
                                                onClick={() => setShowOCR(!showOCR)}
                                                className="flex items-center gap-1.5 px-3 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                                                title={t.tooltipOCR}
                                            >
                                                {showOCR ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                            </button>
                                            <button
                                                onClick={() => setShowResetModal(true)}
                                                className="flex items-center gap-1.5 px-3 py-2 text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition border border-gray-200 dark:border-gray-700 hover:border-red-200 dark:hover:border-red-800"
                                                title={t.tooltipReset}
                                            >
                                                <RefreshCw className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Title */}
                                    <h1 className="text-2xl sm:text-4xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">{t.title}</h1>
                                </div>
                                <p className="text-sm sm:text-base text-gray-500 dark:text-gray-400 mt-2">{t.subtitle}</p>
                                <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{appVersion} â€¢ {t.autoSaved}</p>
                            </div>

                            {/* Drag and Drop Zone */}
                            {showOCR && (
                            <div className="mb-6">
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => handleScanReceipt(e.target.files[0])}
                                    className="hidden"
                                />
                                <div
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                    onClick={triggerFileInput}
                                    className={`relative border-2 border-dashed rounded-xl p-8 sm:p-12 text-center cursor-pointer transition-all ${
                                        isDragging 
                                            ? 'border-gray-900 dark:border-gray-300 bg-gray-50 dark:bg-gray-700 scale-[1.02]' 
                                            : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-700'
                                    } ${isScanning ? 'pointer-events-none opacity-50' : ''}`}
                                >
                                    <div className="flex flex-col items-center gap-3">
                                        <div className={`rounded-full p-4 transition-colors ${
                                            isDragging ? 'bg-gray-900 dark:bg-gray-300' : 'bg-gray-100 dark:bg-gray-700'
                                        }`}>
                                            <Camera className={`w-8 h-8 ${isDragging ? 'text-white dark:text-gray-900' : 'text-gray-600 dark:text-gray-300'}`} />
                                        </div>
                                        <div>
                                            <p className="text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100 mb-1">
                                                {isDragging ? t.dropToScan : t.scanReceipt}
                                            </p>
                                            <p className="text-sm text-gray-500 dark:text-gray-400">
                                                {t.scanReceiptDesc}
                                            </p>
                                            <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                                {t.scanReceiptFormat}
                                            </p>
                                        </div>
                                        {!isScanning && (
                                            <button
                                                type="button"
                                                className="mt-2 inline-flex items-center gap-2 bg-gray-900 dark:bg-gray-700 text-white px-6 py-2.5 rounded-lg hover:bg-black dark:hover:bg-gray-600 transition shadow-sm font-medium"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    triggerFileInput();
                                                }}
                                            >
                                                <Upload className="w-5 h-5" />
                                                {t.chooseFile}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Disclaimer */}
                                <div className="mt-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 flex gap-2 items-center">
                                    <span className="text-amber-600 text-lg flex-shrink-0 leading-none mt-0.5">âš ï¸</span>
                                    <div className="text-xs text-amber-800 dark:text-amber-200 flex-1">
                                        <span className="font-semibold">{t.noteTitle}</span> {t.noteDesc}
                                    </div>
                                </div>
                            </div>
                            )}

                            {/* People Section */}
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-6 border border-gray-200 dark:border-gray-700">
                                <div className="flex items-center gap-2 mb-4 border-b border-gray-100 dark:border-gray-700 pb-2">
                                    <Users className="w-5 h-5 text-gray-700 dark:text-gray-300" />
                                    <h2 className="text-lg font-bold text-gray-900 dark:text-gray-100">{t.peopleList}</h2>
                                </div>
                                <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                    <input
                                        type="text"
                                        value={newPersonName}
                                        onChange={(e) => setNewPersonName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addPerson()}
                                        placeholder={t.personNamePlaceholder}
                                        className="flex-1 px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-1 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-gray-900 dark:focus:border-gray-500 focus:outline-none bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-base sm:text-sm"
                                        title={t.tooltipPersonName}
                                    />
                                    <button
                                        onClick={addPerson}
                                        className="bg-gray-900 dark:bg-gray-700 text-white px-6 py-2.5 rounded-lg hover:bg-black dark:hover:bg-gray-600 transition shadow-sm font-medium"
                                    title={t.tooltipAddPerson}
                                    >
                                        {t.add}
                                    </button>
                                </div>
                                {persons.length === 0 ? (
                                    <p className="text-sm text-gray-400 dark:text-gray-500 italic">{t.noPeopleAdded}</p>
                                ) : (
                                    <div className="flex flex-wrap gap-2">
                                        {persons.map(person => (
                                            <div key={person} className="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-2 rounded-full flex items-center gap-2 border border-gray-200 dark:border-gray-600 shadow-sm">
                                                <span className="font-medium text-sm">{person}</span>
                                                <button
                                                    onClick={() => removePerson(person)}
                                                    className="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition p-1"
                                                    title={t.tooltipRemovePerson}
                                                >
                                                    <span className="block w-3 h-3 leading-3">Ã—</span>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Items Section */}
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-6 border border-gray-200 dark:border-gray-700">
                                <div className="flex items-center gap-2 mb-4 border-b border-gray-100 dark:border-gray-700 pb-2">
                                    <DollarSign className="w-5 h-5 text-gray-700 dark:text-gray-300" />
                                    <h2 className="text-lg font-bold text-gray-900 dark:text-gray-100">{t.itemsList}</h2>
                                </div>
                                
                                <div className="space-y-6">
                                    {items.map((item, index) => (
                                        <div 
                                            key={item.id} 
                                            draggable
                                            onDragStart={(e) => handleItemDragStart(e, index)}
                                            onDragOver={(e) => handleItemDragOver(e, index)}
                                            onDragEnd={handleItemDragEnd}
                                            className={`bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 relative group transition-all ${
                                                draggedItem === index ? 'opacity-50' : ''
                                            } ${
                                                dragOverIndex === index && draggedItem !== index ? 'border-gray-900 dark:border-gray-300 border-2' : ''
                                            }`}
                                        >
                                            <div className="flex gap-3 items-start mb-3">
                                                <button className="cursor-grab active:cursor-grabbing p-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition">
                                                    <GripVertical className="w-5 h-5" />
                                                </button>
                                                <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                    <input
                                                        type="text"
                                                        value={item.name}
                                                        onChange={(e) => updateItem(item.id, 'name', e.target.value)}
                                                        placeholder={`${t.itemPlaceholder}${index + 1}`}
                                                        className="px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-1 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-gray-900 dark:focus:border-gray-500 focus:outline-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-base sm:text-sm"
                                                        title={t.tooltipItemName}
                                                    />
                                                    <FormattedInput 
                                                        value={item.price}
                                                        onChange={(val) => updateItem(item.id, 'price', val)}
                                                        title={t.tooltipItemPrice}
                                                    />
                                                </div>
                                                
                                                <button
                                                    onClick={() => removeItem(item.id)}
                                                    className="p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 hover:border-red-200 dark:hover:border-red-800 transition shadow-sm h-[46px] w-[46px] sm:h-[42px] sm:w-[42px] flex items-center justify-center shrink-0"
                                                    title={t.tooltipDeleteItem}
                                                >
                                                    <Trash2 className="w-5 h-5" />
                                                </button>
                                            </div>

                                            {/* Price Type Toggle */}
                                            <div className="mb-3 flex items-center gap-2">
                                                <span className="text-xs text-gray-500 dark:text-gray-300 font-medium">{t.priceTypeLabel}:</span>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => updateItem(item.id, 'priceType', 'unit')}
                                                        className={`px-3 py-1 rounded-md text-xs font-medium transition border ${
                                                            item.priceType === 'unit'
                                                                ? 'bg-gray-900 dark:bg-gray-600 text-white border-gray-900 dark:border-gray-600'
                                                                : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'
                                                        }`}
                                                        title={t.tooltipPricePerUnit}
                                                    >
                                                        {t.pricePerUnit}
                                                    </button>
                                                    <button
                                                        onClick={() => updateItem(item.id, 'priceType', 'total')}
                                                        className={`px-3 py-1 rounded-md text-xs font-medium transition border ${
                                                            item.priceType === 'total'
                                                                ? 'bg-gray-900 dark:bg-gray-600 text-white border-gray-900 dark:border-gray-600'
                                                                : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'
                                                        }`}
                                                        title={t.tooltipPriceTotal}
                                                    >
                                                        {t.priceTotal}
                                                    </button>
                                                </div>
                                                {item.persons.length > 0 && (
                                                    <span className="text-xs text-gray-400 dark:text-gray-300 ml-2">
                                                        {item.priceType === 'unit' 
                                                            ? `(${item.persons.length}x Rp ${formatMoney(Number(item.price || 0))} = Rp ${formatMoney(Number(item.price || 0) * item.persons.length)})`
                                                            : `(Rp ${formatMoney(Number(item.price || 0))} Ã· ${item.persons.length} = Rp ${formatMoney(Number(item.price || 0) / item.persons.length)})`
                                                        }
                                                    </span>
                                                )}
                                            </div>

                                            <div className="mt-4">
                                                <div className="flex flex-wrap gap-2">
                                                    {persons.length === 0 ? (
                                                        <span className="text-xs text-gray-400 dark:text-gray-500">{t.addPeopleFirst}</span>
                                                    ) : persons.map(person => (
                                                        <button
                                                            key={person}
                                                            onClick={() => togglePerson(item.id, person)}
                                                            className={`px-4 py-2 rounded-full text-sm font-medium transition border select-none ${
                                                                item.persons.includes(person)
                                                                    ? 'bg-gray-900 dark:bg-gray-600 text-white border-gray-900 dark:border-gray-600 shadow-sm'
                                                                    : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'
                                                            }`}
                                                            title={t.tooltipPersonSelect}
                                                        >
                                                            {person}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <button
                                    onClick={addItem}
                                    className="w-full mt-6 border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 py-3 rounded-lg hover:border-gray-400 dark:hover:border-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition flex items-center justify-center gap-2"
                                    title={t.tooltipAddItem}
                                >
                                    <Plus className="w-5 h-5" />
                                    {t.addItem}
                                </button>
                            </div>

                            {/* Additional Costs Section */}
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-6 border border-gray-200 dark:border-gray-700">
                                <div className="flex items-center gap-2 mb-4 border-b border-gray-100 dark:border-gray-700 pb-2">
                                    <CreditCard className="w-5 h-5 text-gray-700 dark:text-gray-300" />
                                    <h2 className="text-lg font-bold text-gray-900 dark:text-gray-100">{t.additionalCosts}</h2>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <FormattedInput label={t.shipping} value={ongkir} onChange={setOngkir} title={t.tooltipShipping} />
                                    <FormattedInput label={t.serviceFee} value={biayaLayanan} onChange={setBiayaLayanan} title={t.tooltipServiceFee} />
                                    <FormattedInput label={t.tax} value={tax} onChange={setTax} type="percentage" placeholder="0" title={t.tooltipTax} />
                                    <FormattedInput label={t.parking} value={parking} onChange={setParking} title={t.tooltipParking} />
                                    <FormattedInput label={t.promoDiscount} value={diskon} onChange={setDiskon} title={t.tooltipDiscount} />
                                    <FormattedInput label={t.voucher} value={voucher} onChange={setVoucher} title={t.tooltipVoucher} />
                                    
                                    {/* Account Selector Component */}
                                    <AccountSelector 
                                        label={t.bankAccount}
                                        options={bankAccounts}
                                        selectedValue={selectedAccount}
                                        onChange={setSelectedAccount}
                                        customName={customAccountName}
                                        customNumber={customAccountNumber}
                                        customVendor={customAccountVendor}
                                        onCustomNameChange={setCustomAccountName}
                                        onCustomNumberChange={setCustomAccountNumber}
                                        onCustomVendorChange={setCustomAccountVendor}
                                        onSaveCustomAccount={saveCustomAccount}
                                        onDeleteAccount={deleteBankAccount}
                                        t={t}
                                    />
                                    
                                    {/* Rounding Toggle */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 dark:text-gray-300 uppercase mb-1">{t.roundTo100}</label>
                                        <button
                                            onClick={() => setRoundTo100(!roundTo100)}
                                            className={`w-full px-4 py-2.5 rounded-lg border transition flex items-center justify-between ${
                                                roundTo100
                                                    ? 'bg-gray-900 dark:bg-gray-600 text-white border-gray-900 dark:border-gray-600'
                                                    : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'
                                            }`}
                                            title={t.tooltipRounding}
                                        >
                                            <span className="text-base sm:text-sm font-medium">{roundTo100 ? 'ON' : 'OFF'}</span>
                                            <div className={`w-10 h-5 rounded-full transition ${
                                                roundTo100 ? 'bg-white dark:bg-gray-300' : 'bg-gray-300 dark:bg-gray-600'
                                            } relative`}>
                                                <div className={`absolute top-0.5 w-4 h-4 rounded-full transition-all ${
                                                    roundTo100 ? 'right-0.5 bg-gray-900 dark:bg-gray-600' : 'left-0.5 bg-white dark:bg-gray-300'
                                                }`}></div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Section */}
                            {subtotal > 0 && persons.length > 0 && (
                                <>
                                    <div className="mb-6 overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <div 
                                            ref={summaryRef} 
                                            className="bg-gray-50 dark:bg-gray-800 p-5 sm:p-8"
                                        > 
                                            <div className="flex items-center gap-3 mb-5">
                                                <div className="bg-gray-900 dark:bg-gray-700 rounded-full p-1.5">
                                                    <DollarSign className="w-5 h-5 text-white" />
                                                </div>
                                                <h2 className="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide leading-none">
                                                    {t.paymentSummary}
                                                </h2>
                                            </div>
                                            
                                            <div className="space-y-3 mb-5 text-sm border-b border-gray-300 dark:border-gray-600 pb-4">
                                                <div className="flex justify-between items-center gap-4">
                                                    <span className="text-gray-600 dark:text-gray-400 whitespace-nowrap">{t.orderSubtotal}</span>
                                                    <span className="font-mono text-gray-900 dark:text-gray-100 whitespace-nowrap">Rp {formatMoney(subtotal)}</span>
                                                </div>

                                                {taxAmount > 0 && (
                                                    <div className="flex justify-between items-center gap-4">
                                                        <span className="text-gray-600 dark:text-gray-400 whitespace-nowrap">{t.tax} ({tax}%):</span>
                                                        <span className="font-mono text-gray-900 dark:text-gray-100 whitespace-nowrap">Rp {formatMoney(taxAmount)}</span>
                                                    </div>
                                                )}

                                                {Number(ongkir) > 0 && (
                                                    <div className="flex justify-between items-center gap-4">
                                                        <span className="text-gray-600 dark:text-gray-400 whitespace-nowrap">{t.shipping}:</span>
                                                        <span className="font-mono text-gray-900 dark:text-gray-100 whitespace-nowrap">Rp {formatMoney(Number(ongkir))}</span>
                                                    </div>
                                                )}

                                                {Number(biayaLayanan) > 0 && (
                                                    <div className="flex justify-between items-center gap-4">
                                                        <span className="text-gray-600 dark:text-gray-400 whitespace-nowrap">{t.serviceFee}:</span>
                                                        <span className="font-mono text-gray-900 dark:text-gray-100 whitespace-nowrap">Rp {formatMoney(Number(biayaLayanan))}</span>
                                                    </div>
                                                )}

                                                {Number(parking) > 0 && (
                                                    <div className="flex justify-between items-center gap-4">
                                                        <span className="text-gray-600 dark:text-gray-400 whitespace-nowrap">{t.parking}:</span>
                                                        <span className="font-mono text-gray-900 dark:text-gray-100 whitespace-nowrap">Rp {formatMoney(Number(parking))}</span>
                                                    </div>
                                                )}

                                                {totalDiscount > 0 && (
                                                    <div className="flex justify-between items-center gap-4">
                                                        <span className="text-gray-600 dark:text-gray-400 whitespace-nowrap">{t.totalDiscount}</span>
                                                        <span className="font-mono text-gray-900 dark:text-gray-100 whitespace-nowrap">- Rp {formatMoney(totalDiscount)}</span>
                                                    </div>
                                                )}
                                                
                                                <div className="flex justify-between items-center gap-4 pt-2">
                                                    <span className="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100 whitespace-nowrap">{t.total}</span>
                                                    <span className="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100 whitespace-nowrap">Rp {formatMoney(grandTotal)}</span>
                                                </div>
                                            </div>

                                            {selectedAccount && selectedAccount !== 'CUSTOM' && selectedAccount !== null && (
                                                <div className="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl p-4 sm:p-5 mb-5">
                                                    <div className="flex items-center gap-2 mb-2 text-gray-500 dark:text-gray-400">
                                                        <CreditCard className="w-4 h-4 flex-shrink-0" />
                                                        <span className="text-xs font-bold uppercase tracking-wider whitespace-nowrap">{t.transferTo} {getSelectedAccountName()}</span>
                                                    </div>
                                                    <div className="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100 tracking-tight whitespace-nowrap">
                                                        {getSelectedAccountVendor()} - {getSelectedAccountNumber()}
                                                    </div>
                                                </div>
                                            )}

                                            <div>
                                                <h3 className="font-bold text-gray-900 dark:text-gray-100 mb-3 text-xs uppercase tracking-widest">{t.splitPerPerson}</h3>
                                                <div className="space-y-2">
                                                    {persons.map(person => {
                                                        const personItems = getPersonItems(person);
                                                        const isOpen = openAccordions[person] || false;
                                                        
                                                        return (
                                                            <div key={person} className="bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 overflow-hidden">
                                                                {/* Accordion Header */}
                                                                <div 
                                                                    className="flex justify-between items-center p-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition"
                                                                    title={t.tooltipViewDetails}
                                                                    onClick={() => toggleAccordion(person)}
                                                                >
                                                                    <div className="flex items-center gap-2 flex-1 min-w-0">
                                                                        <span className="font-medium text-gray-700 dark:text-gray-200 truncate">{person}</span>
                                                                        <button 
                                                                            className="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition flex-shrink-0"
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                toggleAccordion(person);
                                                                            }}
                                                                        >
                                                                            <ChevronDown className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                                                                        </button>
                                                                    </div>
                                                                    <span className="text-base sm:text-lg font-bold text-gray-900 dark:text-gray-100 font-mono whitespace-nowrap flex-shrink-0 ml-4">
                                                                        Rp {formatMoneySplit(roundTo100 ? roundToNearest100(personTotals[person] || 0) : (personTotals[person] || 0))}
                                                                    </span>
                                                                </div>
                                                                
                                                                {/* Accordion Content */}
                                                                {isOpen && (
                                                                    <div className="border-t border-gray-100 dark:border-gray-600 p-3 bg-gray-50 dark:bg-gray-800 animate-slide-down">
                                                                        <div className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                                                                            {t.orderDetails}
                                                                        </div>
                                                                        {personItems.length === 0 ? (
                                                                            <p className="text-xs text-gray-400 dark:text-gray-500 italic">{t.noItems}</p>
                                                                        ) : (
                                                                            <div className="space-y-3">
                                                                                <div className="space-y-2">
                                                                                    {personItems.map(item => {
                                                                                        const itemPrice = Number(item.price || 0);
                                                                                        let displayPrice;
                                                                                        
                                                                                        if (item.priceType === 'total') {
                                                                                            displayPrice = itemPrice / item.persons.length;
                                                                                        } else {
                                                                                            displayPrice = itemPrice;
                                                                                        }
                                                                                        
                                                                                        return (
                                                                                            <div key={item.id} className="flex justify-between items-start gap-2 text-xs">
                                                                                                <div className="flex-1 min-w-0">
                                                                                                    <div className="font-medium text-gray-700 dark:text-gray-200 truncate">
                                                                                                        {item.name || t.itemPlaceholder}
                                                                                                    </div>
                                                                                                    {item.priceType === 'total' && item.persons.length > 1 && (
                                                                                                        <div className="text-gray-400 dark:text-gray-500 text-xs">
                                                                                                            {t.priceTotal}: Rp {formatMoney(itemPrice)} Ã· {item.persons.length}
                                                                                                        </div>
                                                                                                    )}
                                                                                                </div>
                                                                                                <span className="font-mono text-gray-600 dark:text-gray-300 whitespace-nowrap flex-shrink-0">
                                                                                                    Rp {formatMoney(displayPrice)}
                                                                                                </span>
                                                                                            </div>
                                                                                        );
                                                                                    })}
                                                                                </div>
                                                                                
                                                                                {/* Order Subtotal */}
                                                                                <div className="border-t border-gray-200 dark:border-gray-700 pt-2 flex justify-between items-center text-xs">
                                                                                    <span className="font-semibold text-gray-700 dark:text-gray-300">Order Subtotal:</span>
                                                                                    <span className="font-mono font-semibold text-gray-900 dark:text-gray-100">
                                                                                        Rp {formatMoneySplit(personSubtotals[person] || 0)}
                                                                                    </span>
                                                                                </div>
                                                                                
                                                                                {/* Net shared amount share */}
                                                                                {netSharedAmount !== 0 && subtotal > 0 && (
                                                                                    <div className={`flex justify-between items-center text-xs ${netSharedAmount < 0 ? 'text-green-600 dark:text-green-400' : 'text-gray-600 dark:text-gray-400'}`}>
                                                                                        <span>Net Shared ({netSharedAmount < 0 ? 'Discount' : 'Fees'}):</span>
                                                                                        <span className="font-mono">
                                                                                            {netSharedAmount < 0 ? '- ' : '+ '}Rp {formatMoneySplit(Math.abs(netSharedAmount * (personSubtotals[person] / subtotal)))}
                                                                                        </span>
                                                                                    </div>
                                                                                )}
                                                                                
                                                                                {/* Final total */}
                                                                                <div className="border-t border-gray-300 dark:border-gray-600 pt-2 flex justify-between items-center text-xs">
                                                                                    <span className="font-bold text-gray-900 dark:text-gray-100">{t.total}:</span>
                                                                                    <span className="font-mono font-bold text-gray-900 dark:text-gray-100">
                                                                                        {roundTo100 && (personTotals[person] || 0) !== roundToNearest100(personTotals[person] || 0) ? (
                                                                                            <>
                                                                                                <span className="text-gray-400 dark:text-gray-500">Rp {formatMoneySplit(personTotals[person] || 0)}</span>
                                                                                                <span className="mx-1 text-gray-400 dark:text-gray-500">â†’</span>
                                                                                                <span className="text-green-600 dark:text-green-400">Rp {formatMoneySplit(roundToNearest100(personTotals[person] || 0))}</span>
                                                                                            </>
                                                                                        ) : (
                                                                                            `Rp ${formatMoneySplit(personTotals[person] || 0)}`
                                                                                        )}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Action Buttons */}
                                    <div className="flex flex-col sm:flex-row gap-4">
                                        <button
                                            onClick={() => handleCapture('download')}
                                            disabled={isCapturing}
                                            className="flex-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
                                            title={t.tooltipDownload}
                                        >
                                            <Download className="w-5 h-5" />
                                            {t.download}
                                        </button>
                                        <button
                                            onClick={() => handleCapture('copy')}
                                            disabled={isCapturing}
                                            className="flex-1 bg-gray-900 dark:bg-gray-700 text-white py-3 rounded-lg hover:bg-black dark:hover:bg-gray-600 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-gray-200 dark:shadow-gray-900"
                                            title={t.tooltipCopy}
                                        >
                                            <Copy className="w-5 h-5" />
                                            {t.copyImage}
                                        </button>
                                    </div>
                                </>
                            )}

                            {/* Status Notification */}
                            {(captureStatus || isScanning) && (
                                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 animate-slide-down w-[90%] max-w-xs sm:max-w-sm">
                                    <div className="px-4 py-3 rounded-lg shadow-xl font-medium border text-sm sm:text-base bg-gray-900 dark:bg-white text-white dark:text-gray-900 border-gray-900 dark:border-white">
                                        <div className="flex items-center justify-center gap-2">
                                            {(captureStatus.includes('Processing') || captureStatus.includes('Memproses') || isScanning) && (
                                                <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                            )}
                                            <span>{captureStatus}</span>
                                        </div>
                                        {isScanning && scanProgress > 0 && (
                                            <div className="mt-2">
                                                <div className="w-full bg-gray-700 dark:bg-gray-300 rounded-full h-2">
                                                    <div 
                                                        className="bg-white dark:bg-gray-900 h-2 rounded-full transition-all duration-300"
                                                        style={{ width: `${scanProgress}%` }}
                                                    ></div>
                                                </div>
                                                <div className="text-xs text-center mt-1">{scanProgress}%</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Confirmation Modal */}
                            <ConfirmModal
                                isOpen={showResetModal}
                                onConfirm={resetAllData}
                                onCancel={() => setShowResetModal(false)}
                                title={t.resetTitle}
                                message={t.resetMessage}
                                confirmText={t.reset}
                                cancelText={t.cancel}
                            />
                        </div>
                    </div>

                    {/* Floating Calculator - Desktop Only */}
                    {showCalculator && (
                        <div className="hidden md:block fixed top-20 right-6 z-40 animate-fade-in">
                            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 p-4 w-64">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-sm font-bold text-gray-900 dark:text-gray-100">Calculator</span>
                                    <button
                                        onClick={() => setShowCalculator(false)}
                                        className="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition"
                                    >
                                        <span className="text-xl leading-none">Ã—</span>
                                    </button>
                                </div>
                                <div className="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 mb-3">
                                    <div className="text-sm font-mono text-gray-500 dark:text-gray-400 text-right mb-1 h-5 truncate">
                                        {calcHistory || '\u00A0'}
                                    </div>
                                    <div className="text-2xl font-mono font-bold text-gray-900 dark:text-gray-100 text-right truncate">
                                        {calcDisplay}
                                    </div>
                                </div>
                                <div className="grid grid-cols-4 gap-2">
                                    <button onClick={handleCalcClear} className="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">C</button>
                                    <button onClick={handleCalcBackspace} className="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition text-xl">âŒ«</button>
                                    <button onClick={() => handleCalcOperation('Ã·')} className="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">Ã·</button>
                                    <button onClick={() => handleCalcOperation('Ã—')} className="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">Ã—</button>
                                    
                                    {['7','8','9'].map(n => (
                                        <button key={n} onClick={() => handleCalcNumber(n)} className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">{n}</button>
                                    ))}
                                    <button onClick={() => handleCalcOperation('-')} className="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">-</button>
                                    
                                    {['4','5','6'].map(n => (
                                        <button key={n} onClick={() => handleCalcNumber(n)} className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">{n}</button>
                                    ))}
                                    <button onClick={() => handleCalcOperation('+')} className="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">+</button>
                                    
                                    {['1','2','3'].map(n => (
                                        <button key={n} onClick={() => handleCalcNumber(n)} className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">{n}</button>
                                    ))}
                                    <button onClick={handleCalcEquals} className="row-span-2 bg-gray-900 dark:bg-gray-600 hover:bg-black dark:hover:bg-gray-500 text-white rounded-lg py-3 font-semibold transition">=</button>
                                    
                                    <button onClick={() => handleCalcNumber('0')} className="col-span-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">0</button>
                                    <button onClick={() => handleCalcNumber('.')} className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg py-3 font-semibold transition">.</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SplitBill />);
    </script>
</body>
</html>
